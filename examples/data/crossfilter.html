<!DOCTYPE HTML>
<html>
  <head>
    <title>Dataflow CrossFilter</title>
    <script src="../../build/vega-dataflow.js"></script>
    <script src="../interact.js"></script>
    <style>
      body { margin: 10px; }
      rect { fill: steelblue; stroke: none; }
      .base rect { fill: #ccc; }
      .line { fill: firebrick; }
      .brush {
        fill: #fcfcfc;
        cursor: ew-resize;
      }
      .base, .filt, .line {
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <svg class="vis" width="501" height="320">
      <g id="view1">
        <rect class="brush" x="0" y="0" width="0" height="100"></rect>
        <g class="base">
          <rect id="b00" x=  "0" y="0" width="25" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="25" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="25" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="25" height="0"></rect>
          <rect id="b40" x="100" y="0" width="25" height="0"></rect>
          <rect id="b50" x="125" y="0" width="25" height="0"></rect>
          <rect id="b60" x="150" y="0" width="25" height="0"></rect>
          <rect id="b70" x="175" y="0" width="25" height="0"></rect>
          <rect id="b80" x="200" y="0" width="25" height="0"></rect>
          <rect id="b90" x="225" y="0" width="25" height="0"></rect>
          <rect id="b01" x="250" y="0" width="25" height="0"></rect>
          <rect id="b11" x="275" y="0" width="25" height="0"></rect>
          <rect id="b21" x="300" y="0" width="25" height="0"></rect>
          <rect id="b31" x="325" y="0" width="25" height="0"></rect>
          <rect id="b41" x="350" y="0" width="25" height="0"></rect>
          <rect id="b51" x="375" y="0" width="25" height="0"></rect>
          <rect id="b61" x="400" y="0" width="25" height="0"></rect>
          <rect id="b71" x="425" y="0" width="25" height="0"></rect>
          <rect id="b81" x="450" y="0" width="25" height="0"></rect>
          <rect id="b91" x="475" y="0" width="25" height="0"></rect>
        </g>
        <g class="filt">
          <rect id="b00" x=  "0" y="0" width="25" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="25" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="25" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="25" height="0"></rect>
          <rect id="b40" x="100" y="0" width="25" height="0"></rect>
          <rect id="b50" x="125" y="0" width="25" height="0"></rect>
          <rect id="b60" x="150" y="0" width="25" height="0"></rect>
          <rect id="b70" x="175" y="0" width="25" height="0"></rect>
          <rect id="b80" x="200" y="0" width="25" height="0"></rect>
          <rect id="b90" x="225" y="0" width="25" height="0"></rect>
          <rect id="b01" x="250" y="0" width="25" height="0"></rect>
          <rect id="b11" x="275" y="0" width="25" height="0"></rect>
          <rect id="b21" x="300" y="0" width="25" height="0"></rect>
          <rect id="b31" x="325" y="0" width="25" height="0"></rect>
          <rect id="b41" x="350" y="0" width="25" height="0"></rect>
          <rect id="b51" x="375" y="0" width="25" height="0"></rect>
          <rect id="b61" x="400" y="0" width="25" height="0"></rect>
          <rect id="b71" x="425" y="0" width="25" height="0"></rect>
          <rect id="b81" x="450" y="0" width="25" height="0"></rect>
          <rect id="b91" x="475" y="0" width="25" height="0"></rect>
        </g>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
      </g>
      <g id="view2" transform="translate(0, 110)">
        <rect class="brush" x="0" y="0" width="0" height="100"></rect>
        <g class="base">
          <rect id="b00" x=  "0" y="0" width="25" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="25" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="25" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="25" height="0"></rect>
          <rect id="b40" x="100" y="0" width="25" height="0"></rect>
          <rect id="b50" x="125" y="0" width="25" height="0"></rect>
          <rect id="b60" x="150" y="0" width="25" height="0"></rect>
          <rect id="b70" x="175" y="0" width="25" height="0"></rect>
          <rect id="b80" x="200" y="0" width="25" height="0"></rect>
          <rect id="b90" x="225" y="0" width="25" height="0"></rect>
          <rect id="b01" x="250" y="0" width="25" height="0"></rect>
          <rect id="b11" x="275" y="0" width="25" height="0"></rect>
          <rect id="b21" x="300" y="0" width="25" height="0"></rect>
          <rect id="b31" x="325" y="0" width="25" height="0"></rect>
          <rect id="b41" x="350" y="0" width="25" height="0"></rect>
          <rect id="b51" x="375" y="0" width="25" height="0"></rect>
          <rect id="b61" x="400" y="0" width="25" height="0"></rect>
          <rect id="b71" x="425" y="0" width="25" height="0"></rect>
          <rect id="b81" x="450" y="0" width="25" height="0"></rect>
          <rect id="b91" x="475" y="0" width="25" height="0"></rect>
        </g>
        <g class="filt">
          <rect id="b00" x=  "0" y="0" width="25" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="25" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="25" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="25" height="0"></rect>
          <rect id="b40" x="100" y="0" width="25" height="0"></rect>
          <rect id="b50" x="125" y="0" width="25" height="0"></rect>
          <rect id="b60" x="150" y="0" width="25" height="0"></rect>
          <rect id="b70" x="175" y="0" width="25" height="0"></rect>
          <rect id="b80" x="200" y="0" width="25" height="0"></rect>
          <rect id="b90" x="225" y="0" width="25" height="0"></rect>
          <rect id="b01" x="250" y="0" width="25" height="0"></rect>
          <rect id="b11" x="275" y="0" width="25" height="0"></rect>
          <rect id="b21" x="300" y="0" width="25" height="0"></rect>
          <rect id="b31" x="325" y="0" width="25" height="0"></rect>
          <rect id="b41" x="350" y="0" width="25" height="0"></rect>
          <rect id="b51" x="375" y="0" width="25" height="0"></rect>
          <rect id="b61" x="400" y="0" width="25" height="0"></rect>
          <rect id="b71" x="425" y="0" width="25" height="0"></rect>
          <rect id="b81" x="450" y="0" width="25" height="0"></rect>
          <rect id="b91" x="475" y="0" width="25" height="0"></rect>
        </g>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
      </g>
      <g id="view3" transform="translate(0, 220)">
        <rect class="brush" x="0" y="0" width="0" height="100"></rect>
        <g class="base">
          <rect id="b00" x=  "0" y="0" width="25" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="25" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="25" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="25" height="0"></rect>
          <rect id="b40" x="100" y="0" width="25" height="0"></rect>
          <rect id="b50" x="125" y="0" width="25" height="0"></rect>
          <rect id="b60" x="150" y="0" width="25" height="0"></rect>
          <rect id="b70" x="175" y="0" width="25" height="0"></rect>
          <rect id="b80" x="200" y="0" width="25" height="0"></rect>
          <rect id="b90" x="225" y="0" width="25" height="0"></rect>
          <rect id="b01" x="250" y="0" width="25" height="0"></rect>
          <rect id="b11" x="275" y="0" width="25" height="0"></rect>
          <rect id="b21" x="300" y="0" width="25" height="0"></rect>
          <rect id="b31" x="325" y="0" width="25" height="0"></rect>
          <rect id="b41" x="350" y="0" width="25" height="0"></rect>
          <rect id="b51" x="375" y="0" width="25" height="0"></rect>
          <rect id="b61" x="400" y="0" width="25" height="0"></rect>
          <rect id="b71" x="425" y="0" width="25" height="0"></rect>
          <rect id="b81" x="450" y="0" width="25" height="0"></rect>
          <rect id="b91" x="475" y="0" width="25" height="0"></rect>
        </g>
        <g class="filt">
          <rect id="b00" x=  "0" y="0" width="25" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="25" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="25" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="25" height="0"></rect>
          <rect id="b40" x="100" y="0" width="25" height="0"></rect>
          <rect id="b50" x="125" y="0" width="25" height="0"></rect>
          <rect id="b60" x="150" y="0" width="25" height="0"></rect>
          <rect id="b70" x="175" y="0" width="25" height="0"></rect>
          <rect id="b80" x="200" y="0" width="25" height="0"></rect>
          <rect id="b90" x="225" y="0" width="25" height="0"></rect>
          <rect id="b01" x="250" y="0" width="25" height="0"></rect>
          <rect id="b11" x="275" y="0" width="25" height="0"></rect>
          <rect id="b21" x="300" y="0" width="25" height="0"></rect>
          <rect id="b31" x="325" y="0" width="25" height="0"></rect>
          <rect id="b41" x="350" y="0" width="25" height="0"></rect>
          <rect id="b51" x="375" y="0" width="25" height="0"></rect>
          <rect id="b61" x="400" y="0" width="25" height="0"></rect>
          <rect id="b71" x="425" y="0" width="25" height="0"></rect>
          <rect id="b81" x="450" y="0" width="25" height="0"></rect>
          <rect id="b91" x="475" y="0" width="25" height="0"></rect>
        </g>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
      </g>
    </svg><br/>
    <script type="text/javascript">
var tx = vega.transforms;
var g = vega.randomNormal(50, 20);
function gen() {
  var u = -1, v = -1, x = -1;
  while (u < 0 || u >= 100) { u = g.sample(); }
  while (v < 0 || v >= 100) { v = Math.random() < 0.8 ? g.sample() : 100*Math.pow(u/100,2); }
  x = Math.random() < 0.5 ? 100 * Math.random() : 25 + 50 * Math.random();
  return {u:u, v:v, x:x};
}

function updateBrush(_) {
  var line = document.querySelectorAll(_.el + ' rect.line');
  line[0].setAttribute('x', _.x[0]);
  line[1].setAttribute('x', _.x[1]);

  var brush = document.querySelector(_.el + ' rect.brush');
  brush.setAttribute('x', Math.min(_.x[0], _.x[1]));
  brush.setAttribute('width', Math.abs(_.x[1] - _.x[0]));
}

function updateChart(_, pulse) {
  var rect = document.querySelectorAll(_.el + ' > rect'),
      data = pulse.source,
      max  = _.extent[1],
      step = 5, i, b, h;

  for (i=0; i<data.length; ++i) {
    b = ~~(data[i].bin / 5);
    h = 100 * data[i].count / max;
    rect[b].setAttribute('height', h);
    rect[b].setAttribute('y', 100 - h);
  }
}

var u = vega.field('u'),
    v = vega.field('v'),
    x = vega.field('x'),
    count = vega.field('count');

var df = new vega.Dataflow(),
    dn  = df.add(5e5), // Number of tuples
    xd  = df.add(  0), // x-down coordinate

    x1  = df.add([  0, 250]),
    x2  = df.add([250, 500]),
    x3  = df.add([  0, 500]),

    r1  = df.add(range, {x:x1}),
    r2  = df.add(range, {x:x2}),
    r3  = df.add(range, {x:x3}),

    b1  = df.add(updateBrush, {el:'#view1', x:x1}),
    b2  = df.add(updateBrush, {el:'#view2', x:x2}),
    b3  = df.add(updateBrush, {el:'#view3', x:x3}),
    bin = [
      df.add(tx.Bin, {name:'bin', field:u, extent:[0,100], step:5}),
      df.add(tx.Bin, {name:'bin', field:v, extent:[0,100], step:5}),
      df.add(tx.Bin, {name:'bin', field:x, extent:[0,100], step:5})
    ],

    dg  = df.add(tx.Generate, {size:dn, generator:gen}),
    c0  = df.add(tx.Collect, {pulse:dg}),
    cf  = df.add(tx.CrossFilter, {fields:[u,v,x], query:[r1,r2,r3], pulse:c0});

// add histograms
bin.forEach(function(bin, i) {
  var a  = df.add(tx.Aggregate, {groupby:bin, drop:false, pulse:c0}),
      c  = df.add(tx.Collect, {pulse: a}),
      x  = df.add(tx.Extent, {field:count, pulse:c}),

      fr = df.add(tx.ResolveFilter, {ignore:(1<<i), filter:cf, pulse:cf}),
      fa = df.add(tx.Aggregate, {groupby:bin, drop:false, pulse:fr}),
      fc = df.add(tx.Collect, {pulse: fa}),

      dom = '#view' + (i+1) + ' ',
      v  = df.add(updateChart, {el:dom+'.base', pulse:c, extent:x}),
      vf = df.add(updateChart, {el:dom+'.filt', pulse:fc, extent:x});
});

// EVENT HANDLING
var ix = interactors(df),
    filters = [
      function(e) { return e.pageY <= 110; },
      function(e) { return 110 < e.pageY && e.pageY <= 220; },
      function(e) { return 220 < e.pageY && e.pageY <= 330; }
    ];

df.on(ix.mousedown, xd, pageX); // set xdown on mousedown
[x1, x2, x3].forEach(function(x, i) {
  ix.brush('#view'+(i+1)+' .brush', filters[i], x, xd);
});
df.on(ix.mousemove, xd, pageX); // update xdown *after* drags are processed
df.run(); // kick things off
    </script>
  </body>
</html>